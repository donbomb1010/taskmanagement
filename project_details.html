<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - AProjectO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root {
            --bg-color: #F9FAFB;
            --sidebar-width: 260px;
            --primary-black: #000000;
            --text-main: #111827;
            --text-gray: #6B7280;
            --border-color: #E5E7EB;
            --white: #ffffff;
            --blue-btn: #6366F1;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }

        /* Animations */
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--white); border-right: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { display: flex; align-items: center; gap: 10px; margin-bottom: 2.5rem; font-weight: 800; font-size: 1.2rem; }
        .brand-icon { background: var(--primary-black); color: white; width: 32px; height: 32px; border-radius: 8px; display: grid; place-items: center; }
        .menu-title { font-size: 0.75rem; color: #9CA3AF; margin-bottom: 1rem; font-weight: 600; text-transform: uppercase; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 0.75rem 1rem; border-radius: 8px; color: var(--text-gray); text-decoration: none; font-weight: 500; margin-bottom: 0.5rem; transition: 0.2s; }
        .nav-item:hover:not(.active) { background: #F3F4F6; }
        .nav-item.active { background-color: var(--primary-black); color: white; }
        .user-profile { margin-top: auto; display: flex; align-items: center; gap: 12px; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        /* Main Content */
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; position: relative; }

        /* Header */
        .detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; animation: slideInUp 0.4s ease-out forwards; }
        .back-btn { display: inline-flex; align-items: center; gap: 5px; color: var(--text-gray); text-decoration: none; font-weight: 600; margin-bottom: 10px; transition: 0.2s; }
        .back-btn:hover { color: var(--primary-black); }
        .project-title-area h1 { font-size: 2.2rem; font-weight: 800; line-height: 1.2; margin-bottom: 10px; }
        .title-row { display: flex; align-items: center; gap: 15px; }
        .edit-btn { background: #F3F4F6; border: 1px solid #E5E7EB; color: var(--text-main); padding: 5px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: none; align-items: center; gap: 5px; }
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; transition: 0.3s; }
        .status-in-progress { background: #EEF2FF; color: #4F46E5; }
        .status-completed { background: #D1FAE5; color: #065F46; }

        /* Grid */
        .details-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; animation: slideInUp 0.6s ease-out forwards; }
        .main-card { background: white; padding: 2rem; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        
        .project-cover-img { width: 100%; height: 300px; object-fit: contain; background-color: #ffffff; border-radius: 12px; margin-bottom: 2rem; display: none; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 10px; }
        .info-label { font-size: 0.85rem; color: #9CA3AF; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .info-text { font-size: 1rem; line-height: 1.6; color: var(--text-main); margin-bottom: 2rem; white-space: pre-wrap; }

        .leader-box { display: flex; align-items: center; gap: 15px; padding: 15px; background: #F9FAFB; border-radius: 12px; }
        .leader-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .leader-info h4 { font-weight: 700; font-size: 1rem; }
        .leader-info span { font-size: 0.85rem; color: var(--text-gray); }
        .team-avatars-container { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; align-items: center; }
        .team-img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid white; object-fit: cover; }
        .add-member-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px dashed #9CA3AF; display: grid; place-items: center; cursor: pointer; background: white; }

        /* --- TASK SECTION TABS --- */
        .task-section { margin-top: 3rem; }
        
        .tasks-header {
            display: flex; gap: 25px; border-bottom: 2px solid #F3F4F6; margin-bottom: 1.5rem;
        }
        .task-tab {
            padding-bottom: 10px; cursor: pointer; font-weight: 600; color: #9CA3AF; position: relative; transition: color 0.2s;
        }
        .task-tab.active {
            color: var(--primary-black);
        }
        .task-tab.active::after {
            content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background-color: var(--primary-black);
        }

        /* Add Task Button */
        .btn-add-task {
            width: 100%; background-color: #6366F1; color: white; border: none; padding: 14px;
            border-radius: 8px; font-weight: 700; cursor: pointer; display: none; 
            align-items: center; justify-content: center; gap: 8px; margin-top: 25px; transition: 0.2s; font-size: 1rem;
        }
        .btn-add-task:hover { background-color: #4F46E5; }

        .project-task-list { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .empty-msg { text-align: center; color: #9CA3AF; font-size: 0.9rem; padding: 20px; border: 1px dashed #E5E7EB; border-radius: 8px; }

        /* Task Card */
        .task-card {
            background: #FFFFFF; border: 1px solid #E5E7EB; border-radius: 16px; padding: 1.2rem 1.5rem;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: transform 0.2s; position: relative; cursor: pointer;
        }
        .task-card:hover { transform: translateY(-2px); border-color: var(--primary-black); }
        
        .task-checkbox { width: 24px; height: 24px; border: 2px solid #D1D5DB; border-radius: 4px; cursor: pointer; flex-shrink: 0; display: grid; place-items: center; }
        .task-checkbox.checked { background: #6366F1; border-color: #6366F1; color: white; }
        .task-checkbox.disabled { background-color: #F3F4F6; cursor: default; opacity: 0.5; }

        .task-left-col { display: flex; align-items: flex-start; gap: 15px; flex: 2; }
        .task-icon-box { width: 30px; flex-shrink: 0; padding-top: 3px; font-size: 1.4rem; color: #000; }
        .task-details h4 { font-size: 1.05rem; font-weight: 700; color: var(--text-main); margin-bottom: 6px; }
        .task-meta { font-size: 0.8rem; color: #6B7280; margin-bottom: 8px; }
        .task-tags { display: flex; gap: 8px; }
        .task-tag { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .tag-completed { background: #D1FAE5; color: #065F46; }
        .tag-pending { background: #FEE2E2; color: #991B1B; }

        .task-mid-col { flex: 1; display: flex; gap: 30px; justify-content: center; }
        .date-item { display: flex; flex-direction: column; font-size: 0.85rem; }
        .date-label { color: #9CA3AF; font-size: 0.75rem; margin-bottom: 4px; font-weight: 600; }
        .date-val { color: var(--text-gray); font-weight: 500; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }

        .task-right-col { flex: 0.5; display: flex; align-items: center; justify-content: flex-end; gap: 15px; }
        .assignee-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #E5E7EB; }
        .task-chat-icon { font-size: 1.3rem; color: var(--text-main); cursor: pointer; }
        
        .owner-actions { display: none; gap: 8px; margin-left: 10px; }
        .action-icon { padding: 6px; border-radius: 50%; background: #F3F4F6; color: #6B7280; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        .action-icon:hover { background: #000; color: white; }
        .delete-icon:hover { background: #EF4444; color: white; }

        /* Side Stats & Modals */
        .side-card { background: white; padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border-color); height: fit-content; }
        .side-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #F3F4F6; }
        .side-value { font-weight: 600; }
        .progress-wrapper { margin-top: 1rem; }
        .progress-bar-bg { width: 100%; height: 8px; background: #F3F4F6; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { height: 100%; background: var(--primary-black); width: 0%; transition: width 1s ease; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 2000; }
        .modal.active { display: flex; animation: fadeIn 0.2s ease-out forwards; }
        .modal-content { background: white; padding: 2rem; border-radius: 16px; width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid #E5E7EB; padding-bottom: 1rem; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.8rem; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 1rem; outline: none; }
        .image-upload-box { border: 2px dashed #E5E7EB; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; position: relative; transition: 0.2s; }
        .image-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
        .contacts-input-container { background: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #E5E7EB; }
        .contacts-input { border: none; outline: none; width: 100%; font-size: 0.95rem; color: #555; }
        .btn-send-invite { width: 100%; background-color: #6366F1; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 2rem; }
        .btn-cancel { background: white; border: 1px solid #E5E7EB; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-save { background: black; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }

        .view-task-img { width: 100%; height: 250px; object-fit: contain; background: #f9fafb; border-radius: 8px; margin-bottom: 15px; display: none; border: 1px solid #eee; }
        .view-label { font-size: 0.75rem; color: #9CA3AF; font-weight: 700; margin-top: 15px; letter-spacing: 0.5px; text-transform: uppercase; }
        .view-val { font-size: 1rem; color: var(--text-main); margin-bottom: 5px; }
        #viewTaskDesc { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; color: #4B5563; background: #F9FAFB; padding: 15px; border-radius: 8px; margin-top: 5px; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><div class="brand-icon">AP</div><div>AProjectO</div></div>
        <div class="menu-title">Main Menu</div>
        <a href="dashboard.html" class="nav-item"><i class="ri-dashboard-line"></i> Dashboard</a>
        <a href="projects.html" class="nav-item active"><i class="ri-folder-3-fill"></i> Projects</a>
        <a href="notification.html" class="nav-item"><i class="ri-notification-3-line"></i> Notifications</a>
        <a href="chat.html" class="nav-item"><i class="ri-chat-1-line"></i> Chat</a>
        <a href="profile.html" class="nav-item"><i class="ri-user-line"></i> Profile</a>
        <div class="user-profile">
            <img src="" class="avatar-small" id="sidebarAvatar">
            <div class="user-info"><h4 id="sidebarName">...</h4><span style="font-size:0.8rem;">Admin</span></div>
            <i class="ri-logout-box-r-line" onclick="logout()" style="margin-left: auto; cursor: pointer; color: red;"></i>
        </div>
    </aside>

    <main class="main-content">
        <div id="loading" style="text-align:center; margin-top:50px; color:gray;">Loading Project Details...</div>

        <div id="projectContainer" style="display:none;">
            <div class="detail-header">
                <div class="project-title-area">
                    <a href="projects.html" class="back-btn"><i class="ri-arrow-left-line"></i> Back to Projects</a>
                    <div class="title-row">
                        <h1 id="pName">Project Name</h1>
                        <button class="edit-btn" id="editProjectBtn" onclick="openEditProjectModal()"><i class="ri-pencil-line"></i> Edit</button>
                    </div>
                    <span class="status-badge status-in-progress" id="pStatus">In Progress</span>
                </div>
                <div style="text-align:right;">
                    <span class="info-label">CATEGORY</span>
                    <h3 id="pCategory">Development</h3>
                </div>
            </div>

            <div class="details-grid">
                <div class="main-card">
                    <img id="pCoverImage" class="project-cover-img" src="" alt="Project Cover" onerror="this.style.display='none'">
                    <div class="info-label">DESCRIPTION</div><p class="info-text" id="pDesc">No description provided.</p>
                    <div class="info-label">PROJECT LEADER</div>
                    <div class="leader-box">
                        <img src="" class="leader-avatar" id="leaderAvatar">
                        <div class="leader-info"><h4 id="leaderName">...</h4><span id="leaderEmail">...</span></div>
                    </div>
                    <div style="margin-top: 2rem;">
                        <div class="info-label">TEAM MEMBERS</div>
                        <div class="team-avatars-container" id="teamMembers"></div>
                    </div>

                    <div class="task-section">
                        <div class="tasks-header">
                            <div class="task-tab active" onclick="switchTaskTab('pending')">Pending Tasks</div>
                            <div class="task-tab" onclick="switchTaskTab('completed')">Completed Tasks</div>
                        </div>

                        <div id="pendingTasksList" class="project-task-list"></div>
                        <div id="completedTasksList" class="project-task-list" style="display:none;"></div>
                        
                        <button id="addTaskBtn" class="btn-add-task" onclick="openTaskModal()">
                            <i class="ri-add-circle-fill"></i> Add New Sub Task
                        </button>
                    </div>
                </div>

                <div class="side-card">
                    <div class="side-row"><span><i class="ri-calendar-event-line"></i> Created Date</span><span class="side-value" id="pDate">...</span></div>
                    <div class="side-row"><span><i class="ri-time-line"></i> Due Date</span><span class="side-value" id="pDueDate">N/A</span></div>
                    <div class="side-row"><span><i class="ri-flag-line"></i> Priority</span><span class="side-value" id="pPriority" style="color:#EF4444;">High</span></div>
                    <div class="progress-wrapper">
                        <div style="display:flex; justify-content:space-between; font-size:0.9rem; font-weight:600;"><span>Progress</span><span id="pProgressText">0%</span></div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" id="pProgressBar"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal" id="viewTaskModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Task Details</h3><span onclick="closeViewTaskModal()" style="cursor:pointer; font-size:1.5rem;">&times;</span></div>
            <img id="viewTaskImage" class="view-task-img">
            <h2 id="viewTaskTitle" style="margin-bottom: 5px;">Title</h2>
            <span id="viewTaskStatus" class="status-badge status-in-progress">Pending</span>
            <div style="margin-top: 20px;">
                <div class="view-label">DESCRIPTION</div>
                <div id="viewTaskDesc">...</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top:15px;">
                    <div><div class="view-label">START DATE</div><div id="viewTaskStart" class="view-val">...</div></div>
                    <div><div class="view-label">END DATE</div><div id="viewTaskEnd" class="view-val">...</div></div>
                </div>
                <div style="margin-top: 15px;">
                    <div class="view-label">ASSIGNED TO</div>
                    <div class="view-val" id="viewTaskAssignee">...</div>
                </div>
            </div>
            <div class="modal-actions"><button class="btn-cancel" onclick="closeViewTaskModal()">Close</button></div>
        </div>
    </div>

    <div class="modal" id="inviteModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Contacts Info</h3><span onclick="closeInviteModal()" style="cursor:pointer; font-size:1.5rem;">&times;</span></div>
            <div class="contacts-input-container"><input type="email" class="contacts-input" id="inviteEmailInput" placeholder="name@gmail.com"><i class="ri-mail-send-line" style="color:#6366F1;"></i></div>
            <button class="btn-send-invite" onclick="sendProjectInvite()">Send Invitation</button>
        </div>
    </div>

    <div class="modal" id="editProjectModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Edit Project Details</h3><span onclick="closeEditProjectModal()" style="cursor:pointer; font-size:1.5rem;">&times;</span></div>
            <div class="form-group"><label>Project Name</label><input type="text" id="editName"></div>
            <div class="form-group"><label>Category</label><input type="text" id="editCategory"></div>
            <div class="form-group"><label>Description</label><textarea id="editDesc"></textarea></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label>Due Date</label><input type="date" id="editDueDate"></div>
                <div class="form-group"><label>Priority</label><select id="editPriority"><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
            </div>
            <div class="form-group"><label>Progress (%)</label><input type="number" id="editProgress" min="0" max="100"></div>
            <div class="modal-actions"><button class="btn-cancel" onclick="closeEditProjectModal()">Cancel</button><button class="btn-save" onclick="saveProjectChanges()">Save</button></div>
        </div>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="taskModalTitle">Add New Task</h3><span onclick="closeTaskModal()" style="cursor:pointer; font-size:1.5rem;">&times;</span></div>
            <input type="hidden" id="editTaskId"> 
            <div class="form-group">
                <label>Task Image</label>
                <div class="image-upload-box" onclick="document.getElementById('taskImgInput').click()">
                    <div id="taskUploadPlaceholder"><p style="color:#6B7280;">Upload Image</p></div>
                    <img id="taskImgPreview" class="image-preview">
                </div>
                <input type="file" id="taskImgInput" hidden accept="image/*">
            </div>
            <div class="form-group"><label>Title</label><input type="text" id="taskTitle"></div>
            <div class="form-group"><label>Description</label><textarea id="taskDescInput"></textarea></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label>Start Date</label><input type="date" id="taskStartDate"></div>
                <div class="form-group"><label>End Date</label><input type="date" id="taskEndDate"></div>
            </div>
            <div class="form-group"><label>Assign To</label><select id="taskAssignee"></select></div>
            <div class="form-group"><label>Status</label><select id="taskStatus"><option value="Pending">Pending</option><option value="Completed">Completed</option></select></div>
            <div class="modal-actions"><button class="btn-cancel" onclick="closeTaskModal()">Cancel</button><button class="btn-save" onclick="createTask()">Save Task</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, collection, addDoc, updateDoc, query, where, onSnapshot, deleteDoc, arrayUnion, getDocs, enableIndexedDbPersistence 
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDL6UGG7s7o-MC24qpHS77LgY54jxD0sRI",
            authDomain: "taskmanagement-60f9b.firebaseapp.com",
            projectId: "taskmanagement-60f9b",
            storageBucket: "taskmanagement-60f9b.firebasestorage.app",
            messagingSenderId: "761115679422",
            appId: "1:761115679422:web:ee166eb1935bd360aa9cef",
            measurementId: "G-F55KPBTQ3G"
        };

        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dl6gzgu6i/image/upload";
        const CLOUDINARY_UPLOAD_PRESET = "NEWSIMAGE";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 1. ENABLE PERSISTENCE (Speed Fix) ---
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') { console.log('Persistence failed: Multiple tabs'); } 
            else if (err.code == 'unimplemented') { console.log('Persistence not supported'); }
        });

        let currentUser = null;
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        let currentProjectData = null;
        let taskImageUrl = "";

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Sidebar Updates (Wait for DOM)
                const sbName = document.getElementById('sidebarName');
                const sbAvatar = document.getElementById('sidebarAvatar');
                
                // Fetch User for real avatar
                const userSnap = await getDoc(doc(db, "users", user.uid));
                let userPhoto = user.photoURL;
                if (userSnap.exists() && userSnap.data().profileImage) {
                    userPhoto = userSnap.data().profileImage;
                } else if (!userPhoto) {
                    userPhoto = `https://ui-avatars.com/api/?name=${user.displayName}`;
                }

                if(sbName) sbName.innerText = user.displayName || "User";
                if(sbAvatar) sbAvatar.src = userPhoto;

                if(projectId) loadProjectDetails(projectId);
                else window.location.href = "projects.html";
            } else { window.location.href = "login.html"; }
        });

        async function loadProjectDetails(id) {
            try {
                const docRef = doc(db, "projects", id);
                // Real-time listener for the project doc itself
                onSnapshot(docRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentProjectData = data;
                        const isOwner = (data.access_list[0] === currentUser.email);

                        if(isOwner) {
                            document.getElementById('editProjectBtn').style.display = 'flex';
                            document.getElementById('addTaskBtn').style.display = 'flex';
                        }

                        const coverImg = document.getElementById('pCoverImage');
                        if (data.image && data.image.trim() !== "") { coverImg.src = data.image; coverImg.style.display = 'block'; } 
                        else { coverImg.style.display = 'none'; }

                        document.getElementById('pName').innerText = data.name;
                        document.getElementById('pCategory').innerText = data.category;
                        document.getElementById('pDesc').innerText = data.description || "No description.";
                        document.getElementById('pDate').innerText = new Date(data.createdAt.toDate()).toLocaleDateString();
                        document.getElementById('pDueDate').innerText = data.dueDate || "N/A";
                        document.getElementById('pPriority').innerText = data.priority || "High";
                        
                        const progress = data.progress || 0;
                        document.getElementById('pProgressText').innerText = progress + "%";
                        document.getElementById('pProgressBar').style.width = progress + "%";

                        // --- STATUS LOGIC (New) ---
                        const statusElem = document.getElementById('pStatus');
                        if (progress >= 100) {
                            statusElem.innerText = "Completed";
                            statusElem.className = "status-badge status-completed";
                        } else {
                            statusElem.innerText = "In Progress";
                            statusElem.className = "status-badge status-in-progress";
                        }

                        document.getElementById('leaderEmail').innerText = data.access_list[0];
                        document.getElementById('leaderName').innerText = data.access_list[0].split('@')[0].toUpperCase();
                        
                        // Fetch Leader Real Avatar
                        const qLeader = query(collection(db, "users"), where("email", "==", data.access_list[0]));
                        const leaderSnap = await getDocs(qLeader);
                        let leaderImg = `https://ui-avatars.com/api/?name=${data.access_list[0].split('@')[0]}`;
                        if(!leaderSnap.empty && leaderSnap.docs[0].data().profileImage) {
                            leaderImg = leaderSnap.docs[0].data().profileImage;
                        }
                        document.getElementById('leaderAvatar').src = leaderImg;

                        // --- RENDER TEAM MEMBERS (With Real Avatars) ---
                        const teamContainer = document.getElementById('teamMembers');
                        teamContainer.innerHTML = "";
                        const assignSelect = document.getElementById('taskAssignee');
                        assignSelect.innerHTML = "";

                        for (const email of data.access_list) {
                            let memberImg = `https://ui-avatars.com/api/?name=${email.split('@')[0]}`;
                            // Check DB for real image
                            const qMem = query(collection(db, "users"), where("email", "==", email));
                            const memSnap = await getDocs(qMem);
                            if(!memSnap.empty && memSnap.docs[0].data().profileImage) {
                                memberImg = memSnap.docs[0].data().profileImage;
                            }

                            const img = document.createElement('img');
                            img.src = memberImg;
                            img.className = "team-img"; 
                            img.title = email;
                            teamContainer.appendChild(img);
                            
                            const option = document.createElement('option');
                            option.value = email; 
                            option.innerText = email;
                            assignSelect.appendChild(option);
                        }

                        if(isOwner) {
                            const addBtn = document.createElement('div');
                            addBtn.className = "add-member-btn";
                            addBtn.innerHTML = '<i class="ri-add-line"></i>';
                            addBtn.onclick = openInviteModal;
                            teamContainer.appendChild(addBtn);
                        }

                        document.getElementById('loading').style.display = "none";
                        document.getElementById('projectContainer').style.display = "block";
                    }
                });
                
                // Load Tasks (Separate listener)
                loadTasks(projectId); 

            } catch (e) { console.error(e); alert("Error loading details."); }
        }

        window.switchTaskTab = (tab) => {
            const tabs = document.querySelectorAll('.task-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if(tab === 'pending') {
                document.getElementById('pendingTasksList').style.display = 'flex';
                document.getElementById('completedTasksList').style.display = 'none';
            } else {
                document.getElementById('pendingTasksList').style.display = 'none';
                document.getElementById('completedTasksList').style.display = 'flex';
            }
        }

        function loadTasks(pId) {
            const q = query(collection(db, "tasks"), where("projectId", "==", pId));
            onSnapshot(q, (snapshot) => {
                const pendingContainer = document.getElementById('pendingTasksList');
                const completedContainer = document.getElementById('completedTasksList');
                
                pendingContainer.innerHTML = "";
                completedContainer.innerHTML = "";

                let pendCount = 0;
                let compCount = 0;

                snapshot.forEach(doc => {
                    const task = doc.data();
                    const taskIdDisplay = "#" + doc.id.substring(0, 6).toUpperCase();
                    const created = task.createdAt ? new Date(task.createdAt.toDate()) : new Date();
                    const daysAgo = Math.ceil(Math.abs(new Date() - created) / (1000 * 60 * 60 * 24));
                    
                    const isOwner = currentProjectData.access_list[0] === currentUser.email;
                    const isAssignee = task.assignedTo === currentUser.email;
                    const isCreator = task.assignedBy === currentUser.email;
                    
                    let checkboxHtml = '';
                    if(isOwner || isAssignee) {
                         const checkedClass = task.status === 'Completed' ? 'checked' : '';
                         const icon = task.status === 'Completed' ? '<i class="ri-check-line" style="color:white; font-size:14px;"></i>' : '';
                         checkboxHtml = `<div class="task-checkbox ${checkedClass}" onclick="event.stopPropagation(); toggleTask('${doc.id}', '${task.status}')">${icon}</div>`;
                    } else {
                         checkboxHtml = `<div class="task-checkbox disabled" title="No permission"></div>`;
                    }

                    let ownerActions = '';
                    if(isOwner || isCreator) {
                        const tTitle = task.title.replace(/'/g, "\\'");
                        const tDesc = (task.description || "").replace(/'/g, "\\'");
                        const tImg = (task.image || "");
                        ownerActions = `
                        <div class="task-actions">
                            <i class="ri-pencil-line action-icon" onclick="event.stopPropagation(); editTask('${doc.id}', '${tTitle}', '${tDesc}', '${task.startDate}', '${task.endDate}', '${task.assignedTo}', '${task.status}', '${tImg}')" title="Edit"></i>
                            <i class="ri-delete-bin-line action-icon delete-icon" onclick="event.stopPropagation(); deleteTask('${doc.id}')" title="Delete"></i>
                        </div>`;
                    }

                    const statusClass = task.status === 'Completed' ? 'tag-completed' : 'tag-pending';
                    // We use UI Avatar for task assignee for speed, or you could implement the async lookup here too
                    const assigneeAvatar = `https://ui-avatars.com/api/?name=${task.assignedTo.split('@')[0]}`;
                    const vTitle = task.title.replace(/'/g, "\\'");
                    const vDesc = (task.description || "").replace(/'/g, "\\'");
                    const vImg = (task.image || "");

                    const html = `
                        <div class="task-card" onclick="openViewTaskModal('${vTitle}', '${vDesc}', '${task.startDate}', '${task.endDate}', '${task.assignedTo}', '${task.status}', '${vImg}')">
                            <div class="task-left-col">
                                ${checkboxHtml}
                                <div class="task-icon-box"><i class="ri-lightbulb-flash-line"></i></div>
                                <div class="task-info-block">
                                    <h4>${task.title}</h4>
                                    <div class="task-meta">
                                        ${taskIdDisplay} Opened ${daysAgo} days ago by <strong>${task.assignedBy.split('@')[0]}</strong>
                                        <span class="task-tag ${statusClass}">${task.status}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-mid-col">
                                <div class="date-item"><span class="date-label">Start Date</span><span class="date-val"><i class="ri-calendar-line"></i> ${task.startDate || 'N/A'}</span></div>
                                <div class="date-item"><span class="date-label">End Date</span><span class="date-val"><i class="ri-calendar-line"></i> ${task.endDate || 'N/A'}</span></div>
                            </div>
                            <div class="task-right-col">
                                <img src="${assigneeAvatar}" class="assignee-avatar" title="Assigned to: ${task.assignedTo}">
                                <i class="ri-chat-3-line task-chat-icon"></i>
                                ${ownerActions}
                            </div>
                        </div>
                    `;
                    
                    if(task.status === 'Completed') {
                        completedContainer.innerHTML += html;
                        compCount++;
                    } else {
                        pendingContainer.innerHTML += html;
                        pendCount++;
                    }
                });

                if(pendCount === 0) pendingContainer.innerHTML = '<div class="empty-msg">No pending tasks</div>';
                if(compCount === 0) completedContainer.innerHTML = '<div class="empty-msg">No completed tasks</div>';
            });
        }

        window.openViewTaskModal = (title, desc, start, end, assign, status, img) => {
            document.getElementById('viewTaskModal').classList.add('active');
            document.getElementById('viewTaskTitle').innerText = title;
            document.getElementById('viewTaskDesc').innerText = desc || "No description";
            document.getElementById('viewTaskStart').innerText = start || "N/A";
            document.getElementById('viewTaskEnd').innerText = end || "N/A";
            document.getElementById('viewTaskAssignee').innerText = assign;
            document.getElementById('viewTaskStatus').innerText = status;
            const imgElem = document.getElementById('viewTaskImage');
            if(img && img !== "undefined" && img !== "") { imgElem.src = img; imgElem.style.display = "block"; } 
            else { imgElem.style.display = "none"; }
        }
        window.closeViewTaskModal = () => document.getElementById('viewTaskModal').classList.remove('active');

        window.openTaskModal = () => { document.getElementById('taskModal').classList.add('active'); taskImageUrl = ""; document.getElementById('editTaskId').value = ""; document.getElementById('taskTitle').value = ""; document.getElementById('taskDescInput').value = ""; };
        window.closeTaskModal = () => document.getElementById('taskModal').classList.remove('active');

        document.getElementById('taskImgInput').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if(!file) return;
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            try { const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData }); const data = await res.json(); taskImageUrl = data.secure_url; document.getElementById('taskUploadPlaceholder').style.display='none'; document.getElementById('taskImgPreview').src=taskImageUrl; document.getElementById('taskImgPreview').style.display='block'; } catch(e){ console.error(e); }
        });

        window.createTask = async () => {
            const id = document.getElementById('editTaskId').value;
            const title = document.getElementById('taskTitle').value;
            const desc = document.getElementById('taskDescInput').value;
            const start = document.getElementById('taskStartDate').value;
            const end = document.getElementById('taskEndDate').value;
            const assignee = document.getElementById('taskAssignee').value;
            const status = document.getElementById('taskStatus').value;

            if(!title) return alert("Title required");

            try {
                const taskData = { title, description: desc, startDate: start, endDate: end, assignedTo: assignee, status, image: taskImageUrl };

                if(id) {
                    await updateDoc(doc(db, "tasks", id), taskData);
                    alert("Task Updated");
                } else {
                    taskData.assignedBy = currentUser.email;
                    taskData.projectName = currentProjectData.name;
                    taskData.projectId = projectId;
                    taskData.createdAt = new Date();
                    await addDoc(collection(db, "tasks"), taskData);
                    alert("Task Created");
                }
                
                if(assignee !== currentUser.email) {
                    await addDoc(collection(db, "notifications"), {
                        toEmail: assignee, fromEmail: currentUser.email, title: "New Task Assigned",
                        message: `Task: ${title} in project ${currentProjectData.name}`, type: "task", projectId: projectId, timestamp: new Date(), read: false
                    });
                }
                closeTaskModal();
            } catch(e) { alert(e.message); }
        }

        window.editTask = (id, title, desc, start, end, assign, status, img) => {
            document.getElementById('taskModal').classList.add('active');
            document.getElementById('taskModalTitle').innerText = "Edit Task";
            document.getElementById('editTaskId').value = id;
            document.getElementById('taskTitle').value = title;
            document.getElementById('taskDescInput').value = desc;
            document.getElementById('taskStartDate').value = start;
            document.getElementById('taskEndDate').value = end;
            document.getElementById('taskAssignee').value = assign;
            document.getElementById('taskStatus').value = status;
            taskImageUrl = (img && img !== "undefined") ? img : "";
            if(taskImageUrl) { document.getElementById('taskImgPreview').src = taskImageUrl; document.getElementById('taskImgPreview').style.display='block'; document.getElementById('taskUploadPlaceholder').style.display='none'; }
            else { document.getElementById('taskImgPreview').style.display='none'; document.getElementById('taskUploadPlaceholder').style.display='block'; }
        }

        window.deleteTask = async (id) => { if(confirm("Delete task?")) await deleteDoc(doc(db, "tasks", id)); }
        window.toggleTask = async (id, status) => { const newStatus = status === 'Completed' ? 'Pending' : 'Completed'; await updateDoc(doc(db, "tasks", id), { status: newStatus }); }

        // --- NEW LOGIC START ---
        
        window.openInviteModal = () => document.getElementById('inviteModal').classList.add('active');
        window.closeInviteModal = () => document.getElementById('inviteModal').classList.remove('active');

        window.sendProjectInvite = async () => {
            const email = document.getElementById('inviteEmailInput').value.trim();
            if (!email) return alert("Please enter an email address");
            
            try {
                const projectRef = doc(db, "projects", projectId);
                
                // 1. Add to Access List
                await updateDoc(projectRef, { access_list: arrayUnion(email) });

                // 2. Send Notification
                await addDoc(collection(db, "notifications"), {
                    toEmail: email,
                    fromEmail: currentUser.email,
                    title: "Project Invitation",
                    message: `You have been invited to join the project: ${currentProjectData.name}`,
                    type: "invite",
                    projectId: projectId,
                    timestamp: new Date(),
                    read: false
                });

                alert("Invitation sent successfully!");
                closeInviteModal();
                // UI will update via onSnapshot
            } catch (e) {
                console.error(e);
                alert("Error sending invite: " + e.message);
            }
        };

        window.openEditProjectModal = () => {
            if(!currentProjectData) return;
            // Pre-fill inputs
            document.getElementById('editName').value = currentProjectData.name || "";
            document.getElementById('editCategory').value = currentProjectData.category || "";
            document.getElementById('editDesc').value = currentProjectData.description || "";
            document.getElementById('editDueDate').value = currentProjectData.dueDate || "";
            document.getElementById('editPriority').value = currentProjectData.priority || "High";
            document.getElementById('editProgress').value = currentProjectData.progress || 0;

            document.getElementById('editProjectModal').classList.add('active');
        };
        window.closeEditProjectModal = () => document.getElementById('editProjectModal').classList.remove('active');

        window.saveProjectChanges = async () => {
            const name = document.getElementById('editName').value;
            const category = document.getElementById('editCategory').value;
            const desc = document.getElementById('editDesc').value;
            const due = document.getElementById('editDueDate').value;
            const priority = document.getElementById('editPriority').value;
            const progress = document.getElementById('editProgress').value;

            if(!name) return alert("Project Name is required");

            try {
                const projectRef = doc(db, "projects", projectId);
                
                await updateDoc(projectRef, {
                    name: name,
                    category: category,
                    description: desc,
                    dueDate: due,
                    priority: priority,
                    progress: parseInt(progress) || 0
                });

                alert("Project updated successfully!");
                closeEditProjectModal();
                // UI will update via onSnapshot
            } catch (e) {
                console.error(e);
                alert("Error updating project: " + e.message);
            }
        };
        // --- NEW LOGIC END ---

        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
    </script>
</body>
</html>